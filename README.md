---
layout: post
title: Автоматизация создания образов Windows с использованием Packer
date: 2023-10-21
categories:
  - hashicorp
---

# Автоматизация создания образов **Windows** с использованием **Packer**

## Введение

Packer - это инструмент от компании HashiCorp, который позволяет автоматизировать процесс создания однородных образов виртуальных машин, контейнеров и других артефактов развертывания. В этом руководстве мы рассмотрим шаги по созданию образов Windows с использованием Packer.

### Предварительные требования

Прежде чем начать, убедитесь, что у вас установлен Packer и настроен доступ к репозиторию на [GitHub](https://github.com/IVAndr0n/packer-vsphere-windows){:target="_blank" :rel="noopener noreferrer"}. Также убедитесь, что у вас есть доступ к образу Windows, который будет использован для создания образа.

### Структура репозитория на GitHub

Проект содержит каталог файлов для автоматического создания образов виртуальных машин на базе операционных систем Windows с помощью Packer, включая файлы конфигурации, скрипты настройки и скрипты сборки образа.

В репозитории следующая структура:

```sh
$ tree --dirsfirst -F
.
├── add/
│   └── win6.1/  # required updates for windows 7 and Windows Server 2008R2
│       ├── VMware-tools-11.0.6-15940789-i386.exe
│       ├── VMware-tools-11.0.6-15940789-x86_64.exe
│       ├── windows6.1-kb3138612-x64.msu
│       ├── windows6.1-kb3138612-x86.msu
│       ├── windows6.1-kb4474419-v3-x64.msu
│       ├── windows6.1-kb4474419-v3-x86.msu
│       ├── windows6.1-kb4490628-x64.msu
│       ├── windows6.1-kb4490628-x86.msu
│       ├── windows6.1-kb4555449-x64.msu
│       └── windows6.1-kb4555449-x86.msu
├── boot_config/
│   ├── Autounattend-BIOS-x64-7-2008R2.pkrtpl.hcl
│   ├── Autounattend-BIOS-x86-7.pkrtpl.hcl
│   ├── Autounattend-UEFI-x64-10-11-2012R2-2016-2019-2022.pkrtpl.hcl
│   └── Autounattend-UEFI-x86-10.pkrtpl.hcl
├── manifests/
├── scripts/
│   ├── add-win6.1.cmd
│   ├── config.ps1
│   ├── initialize.ps1
│   ├── install-vmtools.ps1
│   ├── remove-apps.ps1
│   └── specialize.ps1
├── build_all_windows_with_duration_record_parallel.ps1
├── build_all_windows_with_duration_record_sequential.ps1
├── build_all_windows_without_duration_record_parallel.cmd
├── README.md
├── template-windows_vsphere.pkr.hcl
├── variables_vsphere.pkr.hcl
├── windows-10-pro-x64_vsphere.pkrvar.hcl
├── windows-10-pro-x86_vsphere.pkrvar.hcl
├── windows-11-pro-x64_vsphere.pkrvar.hcl
├── windows-7-pro-x64_vsphere.pkrvar.hcl
├── windows-7-pro-x86_vsphere.pkrvar.hcl
├── windows-server-2008r2-std-x64_vsphere.pkrvar.hcl
├── windows-server-2012r2-std-x64_vsphere.pkrvar.hcl
├── windows-server-2016-std-x64_vsphere.pkrvar.hcl
├── windows-server-2019-std-x64_vsphere.pkrvar.hcl
└── windows-server-2022-std-x64_vsphere.pkrvar.hcl

5 directories, 36 files
```

### Процесс создания образа виртуальной машины с операционной системой Windows для платформы vSphere

1. **Подготовка переменных**:

- В файле `variables_vsphere.pkr.hcl` определены необходимые переменные, такие как адрес vCenter Server и параметры виртуальной машины.

2. **Настройка переменных для конкретной версии Windows**:

- Созданы файлы переменных `.pkrvar.hcl` для каждой версии Windows, содержащие уникальные параметры, такие как путь к ISO-образу и размер диска.

3. **Создание шаблона**:

- Файл `template-windows_vsphere.pkr.hcl` служит в качестве шаблона, содержащего конфигурацию Packer, локальные переменные и другие настройки.

4. **Подготовка обновлений и скриптов**:

    - Директория `add/` содержит необходимые обновления для Windows.
    - Директория `boot_config/` содержит файлы конфигурации, необходимые для каждой версии Windows. Эти файлы определяют настройки автоматической установки и другие параметры, такие как язык, часовой пояс, ключ продукта и другие параметры конфигурации.
    - Скрипты PowerShell для настройки и установки дополнительного ПО находятся в директории `scripts/`.

5. **Запуск процесса создания образа**:

    - Packer запускается с использованием команды `packer build <template.pkr.hcl>`, указывающей на файл шаблона и соответствующие файлы переменных.
    - Packer будет использовать указанные параметры, загружать ISO-образ операционной системы, создавать виртуальную машину в vSphere, применять необходимые скрипты и обновления, а затем создавать образ виртуальной машины.

6. **Анализ результатов**:

    - После завершения создания образа Packer формирует манифест с информацией о созданном образе, такой как дата создания и версия операционной системы.

### Создание образа с использованием Packer

1. Откройте терминал и перейдите в директорию с файлами Packer, включая ваш файл шаблона.
2. Запустите команду `packer build <template.pkr.hcl>` для начала процесса создания образа. Обратите внимание, что вместо `<template.pkr.hcl>` вы должны указать имя вашего файла шаблона, содержащего конфигурацию образа для Packer.

### Создание множества образов с помощью скриптов

Представленные скрипты предназначены для работы в операционной системе Windows и позволяют создавать образы виртуальных машин для различных версий Windows с использованием Packer.

#### Скрипт `build_all_windows_with_duration_record_parallel.ps1`

Этот скрипт обеспечивает параллельное создание образов, что может снизить общее время создания образов за счет распределения нагрузки на сервер.

1. Откройте терминал PowerShell и перейдите в директорию с файлами Packer.
2. Запустите скрипт `build_all_windows_with_duration_record_parallel.ps1`.
3. Скрипт автоматически найдет все файлы конфигурации Packer (`.pkrvar.hcl`) в текущей директории и запустит процесс создания образов для каждого из них параллельно.
4. В процессе создания каждого образа будет записан лог и файл с длительностью процесса.
5. После завершения работы скрипта можно проверить логи и файлы длительности для анализа производительности и успешности создания образов.

#### Скрипт `build_all_windows_with_duration_record_sequential.ps1`

Этот скрипт обеспечивает последовательное создание образов, что несколько увеличивает общее время создания образов, но снижает нагрузку на сервер.

1. Откройте терминал PowerShell и перейдите в директорию с файлами Packer.
2. Запустите скрипт `build_all_windows_with_duration_record_sequential.ps1`.
3. Скрипт автоматически найдет все файлы конфигурации Packer (`.pkrvar.hcl`) в текущей директории и запустит процесс создания образов для каждого из них последовательно.
4. В процессе создания каждого образа будет записан лог и файл с длительностью процесса.
5. После завершения работы скрипта можно проверить логи и файлы длительности для анализа производительности и успешности создания образов.

#### Скрипт `build_all_windows_without_duration_record_parallel.cmd`

Этот скрипт также обеспечивает параллельное создание образов, но не фиксирует длительность процесса.

1. Откройте терминал CMD и перейдите в директорию с файлами Packer.
2. Запустите скрипт `build_all_windows_without_duration_record_parallel.cmd`.
3. Скрипт автоматически найдет все файлы конфигурации Packer (`.pkrvar.hcl`) в текущей директории и запустит процесс создания образов для каждого из них параллельно.

### Поддерживаемые версии Windows

- Windows 7 x86/x64
- Windows 10 x86/x64
- Windows 11 x64
- Windows 2008 R2 x64
- Windows 2012 R2 x64
- Windows 2016 x64
- Windows 2019 x64
- Windows 2022 x64

### Заключение

**Преимущества использования Packer:**

- **Ускорение развертывания**: Создание однородных образов ускоряет процесс развертывания приложений.
- **Безопасность и надежность**: Предварительно настроенные образы помогают избежать ошибок и уменьшить риск уязвимостей.
- **Консистентность среды**: Образы, созданные с помощью Packer, обеспечивают стабильные и предсказуемые релизы приложений.

**Использование Packer в DevOps практиках позволяет улучшить процессы развертывания, обеспечивая быстрое создание надежных окружений.**
